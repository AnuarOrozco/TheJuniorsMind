<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Juniors Mind | Post Detail</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #fff;
      color: #222;
      line-height: 1.7;
    }
    .container {
      max-width: 1100px;
      margin-top: 40px;
    }
    .post-title {
      font-weight: 600;
      font-size: 2.2rem;
    }
    .post-meta {
      color: #777;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }
    .post-content {
      margin-top: 30px;
      font-size: 1.05rem;
    }
    .sidebar {
      position: sticky;
      top: 100px;
      background-color: #f9f9f9;
      border-left: 2px solid #eee;
      padding: 15px 20px;
      border-radius: 10px;
    }
    .sidebar h5 {
      font-weight: 600;
      margin-bottom: 10px;
    }
    .sidebar ul {
      list-style: none;
      padding-left: 0;
    }
    .sidebar ul li {
      margin-bottom: 8px;
    }
    .sidebar ul li a {
      text-decoration: none;
      color: #007bff;
      font-weight: 500;
      transition: color 0.2s;
    }
    .sidebar ul li a:hover {
      color: #0056b3;
    }
    .tag {
      display: inline-block;
      background-color: #eef2ff;
      color: #3b5bdb;
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 20px;
      margin-right: 5px;
    }
  </style>
</head>
<body>

  <div class="container">
    <div id="post-container" class="row">
      <div class="col-md-8">
        <h1 id="post-title" class="post-title"></h1>
        <p id="post-meta" class="post-meta"></p>
        <div id="post-tags"></div>
        <div id="post-content" class="post-content"></div>
      </div>

      <div class="col-md-4" id="sidebar-container">
        <!-- Índice de contenidos (subposts) se inyectará aquí -->
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id');
    const API_BASE = 'http://localhost:8080/api';

    if (!postId) {
      document.getElementById('post-container').innerHTML =
        '<div class="text-center text-muted"><h3>ID de post faltante en la URL</h3></div>';
      throw new Error('Missing postId');
    }

    async function loadPost() {
      try {
        const res = await fetch(`${API_BASE}/posts/${postId}`);
        if (!res.ok) {
          const errText = await res.text();
          throw new Error(errText || 'Post not found');
        }
        const post = await res.json();

        document.getElementById('post-title').textContent = post.title || 'Sin título';
        document.getElementById('post-meta').textContent =
          `By User #${post.authorId || 'N/A'} | Category #${post.categoryId || 'N/A'} | ${post.createdAt ? new Date(post.createdAt).toLocaleDateString() : 'N/A'}`;

        // Usar innerHTML si el contenido tiene HTML, o textContent si no
        document.getElementById('post-content').innerHTML = post.content || '';

        // Render tags (verificar existencia)
        const tagsDiv = document.getElementById('post-tags');
        tagsDiv.innerHTML = '';
        if (Array.isArray(post.tags)) {
          post.tags.forEach(tag => {
            const span = document.createElement('span');
            span.classList.add('tag');
            span.textContent = tag;
            tagsDiv.appendChild(span);
          });
        }

        // Load subposts dinámicamente
        loadSubposts(post.id || postId);

      } catch (error) {
        document.getElementById('post-container').innerHTML =
          '<div class="text-center text-muted"><h3>Post not found</h3></div>';
        console.error(error);
      }
    }

    async function loadSubposts(postId) {
      try {
        const res = await fetch(`${API_BASE}/subposts`);
        if (!res.ok) throw new Error('Error fetching subposts');
        const allSubposts = await res.json();

        const subposts = allSubposts.filter(sp => sp.postId === Number(postId));
        if (subposts.length === 0) return;

        const sidebar = document.createElement('div');
        sidebar.classList.add('sidebar');

        const title = document.createElement('h5');
        title.textContent = 'Contenido del post';
        sidebar.appendChild(title);

        const list = document.createElement('ul');
        subposts.forEach(sp => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = `#subpost-${sp.id}`;
          a.textContent = sp.subtitle;
          li.appendChild(a);
          list.appendChild(li);

          // Insertar subpost en el contenido principal
          const subEl = document.createElement('div');
          subEl.id = `subpost-${sp.id}`;
          subEl.innerHTML = `
            <h4 class="mt-5">${sp.subtitle}</h4>
            <p>${sp.content}</p>
          `;
          document.getElementById('post-content').appendChild(subEl);
        });

        sidebar.appendChild(list);
        document.getElementById('sidebar-container').appendChild(sidebar);

      } catch (error) {
        console.error('Error loading subposts:', error);
      }
    }

    loadPost();
  </script>

</body>
</html>
